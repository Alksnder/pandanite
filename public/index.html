<!DOCTYPE html>
<html>
	<head>
    <script src="https://unpkg.com/peerjs@1.3.2/dist/peerjs.min.js" crossorigin></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" crossorigin></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.js" integrity="sha512-2PRgAav8Os8vLcOAh1gSaDoNLe1fAyq8/G3QSdyjFFD+OqNjLeHE/8q4+S4MEZgPsuo+itHopj+hJvqS8XUQ8A==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/xterm/3.14.5/xterm.min.css" integrity="sha512-iLYuqv+v/P4u9erpk+KM83Ioe/l7SEmr7wB6g+Kg1qmEit8EShDKnKtLHlv2QXUp7GGJhmqDI+1PhJYLTsfb8w==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script>
      !function(e, t){
        var n = "a.wasm.wasm";
        if(true || !e.WebAssembly){
          n = "a.wasm.js"
        }
        var o = t.createElement("script");
        o.async = !0, o.type = "text/javascript", o.src = n, o.onerror = function(t) {
          console.error("Script Error"), console.error(t), setTimeout(function() {
            e.location.reload(!0)
          }, 3e3)
        };
        var r = t.getElementsByTagName("script")[0];
        r.parentNode.insertBefore(o, r)
      }(window, document);
    </script>
  </head>
	<body style="margin:0px; background-color: black">
		<script>
      $(document).ready(()=> {
        var term = new Terminal({rows: Math.round($(window).height()/20), cols: Math.round($(window).width()/12) });
        term.open(document.getElementById('terminal'));
        window.logMessage = (message) => {
          term.write(message + '\r\n');
        };

        function hexDecode(hexString) {
          return new Uint8Array(hexString.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
        }

        window.receiveResult = function(taskId, result) {
            let _receiveResult = Module.cwrap('receive_result', 'string', ['array'])
            const encoder = new TextEncoder();
            const view = encoder.encode(taskId);
            if (!result) return _receiveResult(view, view.length);
            const data = new Uint8Array([...view, ...new Uint8Array(result)]);
            return _receiveResult(data, data.length);
        }

        window.setAddress = function(address) {
            let _setAddress = Module.cwrap('set_address', 'string', ['array'])
            const encoder = new TextEncoder();
            const view = encoder.encode(address);
            return _setAddress(view, view.length);
        }
        

        window.sendTask = (task) => {
            task = JSON.parse(task);
            if (task.url.indexOf("http://") == 0) {
                let xhr = new XMLHttpRequest();
                xhr.overrideMimeType("text/plain; charset=x-user-defined");
                xhr.responseType = "arraybuffer";
                if (task.data.length == 0)
                  xhr.open("GET", task.url);
                else
                  xhr.open("POST", task.url, true);
                xhr.timeout = task.timeout;
                xhr.onload = (e) => {
                    let buf = xhr.response;
                    // todo concat taskId to buf
                    window.receiveResult(task.taskId, buf);
                }
                xhr.onerror = (e) => {
                    window.receiveResult(task.taskId);
                }
                if (task.data.length == 0) {
                  xhr.send();
                } else {
                  xhr.send(hexDecode(task.data));
                }
                
            } else {
              window.receiveResult(task.taskId);
                // // fetch data via PeerJS
                // // figure out endpoint from url: e.g peer://<peerID>/block?blockId=1
                // var conn = peer.connect(task.url);
                // conn.on('open', function(){
                //     conn.send('REQ:' + task.taskId + ':' + endpoint + ':' + task.data);
                // });
            }
        }

        // peer.on('connection', function(conn) {
        //     conn.on('data', function(data){
        //          if data.slice(3) == 'REQ' 
        //              figure out which endpoint this is, call wasm and send back data
        //          else {}
        //              call window.receiveResult to pass data to wasm
        //     });
        // });
        function checkNodeStatus() {
          if (window.nodeReady) {
            let peer = new Peer();
            peer.on('open', function(id) {
              const peerUrl = 'peer://' + id;
              window.setAddress(peerUrl);
            });
          } else {
            setTimeout(checkNodeStatus, 100);
          }
        }
        checkNodeStatus();
      })
		</script>
    <div id="terminal"></div>
	</body>
</html>